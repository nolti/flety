<main class="main-content" [class.dark-theme]="isDarkMode">
  <button aria-label="Cambiar Tema" matMiniFab (click)="toggleTheme()" class="theme-toggle-button">
      <mat-icon>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</mat-icon>
  </button>

  <div class="container">
    <header class="app-header">
    <div class="logo">
        <img [src]="isDarkMode ? 'assets/images/jp_logo_dark.png' : 'assets/images/jp_logo_light.png'" alt="Flety Express">
  <h1>Flety Express</h1>
    </div>
   </header>
    <mat-card appearance="outlined" class="maincard">
      <mat-card-header>
        <mat-card-title class="card-title">¿Cuánto sale mi flete?</mat-card-title>
        <mat-card-subtitle class="card-subtitle">Calculá el precio y pedí el servicio en segundos!</mat-card-subtitle>
      </mat-card-header>

      <div class="loading-overlay" [class.active]="isCalculating">
        <div class="spinner-container">
          <mat-progress-spinner
            diameter="50"
            mode="indeterminate"
          ></mat-progress-spinner>
          <span>Calculando...</span>
        </div>
      </div>
      <div class="stepper-container">
        <mat-stepper [linear]="true" #stepper (selectionChange)="onStepChange($event)">
          <mat-step [stepControl]="firstFormGroup">
              <form [formGroup]="firstFormGroup">
                  <ng-template matStepLabel>Trayecto</ng-template>
                  <h2 class="section-title">Origen y Destino: <small>Ingresa desde dónde retiramos y hacia dónde enviamos tu Flete.</small></h2>
                  <mat-divider class="section-divider"></mat-divider>
                  <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Desde</mat-label>
                      <input type="text" matInput formControlName="desde" [matAutocomplete]="autoDesde" (blur)="validateAddress('desde')" required>
                      <mat-autocomplete #autoDesde="matAutocomplete">
                          <mat-option *ngFor="let option of filteredDesdeOptions | async" [value]="option">
                              {{option}}
                          </mat-option>
                      </mat-autocomplete>
                      <button matIconButton matSuffix #tooltip="matTooltip"
                              matTooltip="Obtener mi ubicación actual"
                              matTooltipPosition="left" matTooltipHideDelay="5000"
                              aria-label="Obtener mi ubicación actual"
                              (click)="getCurrentLocation()"
                              [disabled]="!mapsReady">
                          <mat-icon aria-label="Obtener mi ubicación actual" fontIcon="my_location" class="location-icon"></mat-icon>
                      </button>

                      <mat-error *ngIf="firstFormGroup.get('desde')?.hasError('required')">
                          El origen es requerido.
                      </mat-error>
                      <mat-error *ngIf="firstFormGroup.get('desde')?.hasError('invalidAddress')">
                          La dirección que escribió no existe, utilice las sugerencias que le indica el Autocompletado para que sea válida su dirección.
                      </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Destino</mat-label>
                      <input type="text" matInput formControlName="destino" [matAutocomplete]="autoDestino" (blur)="validateAddress('destino')" required>
                      <mat-autocomplete #autoDestino="matAutocomplete">
                          <mat-option *ngFor="let option of filteredDestinoOptions | async" [value]="option">
                              {{option}}
                          </mat-option>
                      </mat-autocomplete>
                      <mat-error *ngIf="firstFormGroup.get('destino')?.hasError('required')">
                          El destino es requerido.
                      </mat-error>
                      <mat-error *ngIf="firstFormGroup.get('destino')?.hasError('invalidAddress')">
                          La dirección que escribió no existe, utilice las sugerencias que le indica el Autocompletado para que sea válida su dirección.
                      </mat-error>
                  </mat-form-field>
                  
                  <div class="button-group">
                      <button mat-flat-button matStepperNext *ngIf="firstFormGroup.valid">Continuar</button>
                  </div>
              </form>
          </mat-step>

          <mat-step [stepControl]="secondFormGroup">

                <form [formGroup]="secondFormGroup">
                  <ng-template matStepLabel>¿Qué envías?</ng-template>
                  <h2 class="section-title">¿Qué vas a enviar?</h2>
                  <mat-divider class="section-divider"></mat-divider>

                  <mat-radio-group class="shipping-types" formControlName="tipoEnvio">
                    <div class="shipping-type-option">
                      <mat-radio-button value="mudanza" class="shipping-radio-button">
                        <div class="radio-button-content">
                          <mat-icon class="shipping-icon">local_shipping</mat-icon>
                          <span class="radio-button-label">Mudanza</span>
                          <span class="radio-button-description">Muebles y pertenencias del hogar</span>
                        </div>
                      </mat-radio-button>
                    </div>
                    <mat-divider [vertical]="true" class="shipping-divider"></mat-divider>
                    <div class="shipping-type-option">
                      <mat-radio-button value="articulos" class="shipping-radio-button">
                        <div class="radio-button-content">
                          <mat-icon class="shipping-icon">inventory_2</mat-icon>
                          <span class="radio-button-label">Artículos</span>
                          <span class="radio-button-description">Cajas, paquetes o encomiendas</span>
                        </div>
                      </mat-radio-button>
                    </div>
                  </mat-radio-group>

                  <div *ngIf="secondFormGroup.get('tipoEnvio')?.value === 'articulos'" class="articles-section">

                    <div class="add-article-button-container">
                      <button mat-stroked-button (click)="openArticleDialog()">
                        <mat-icon>add</mat-icon>
                        Añadir Artículo
                      </button>
                    </div>

                    <ng-container *ngIf="(dataSource | async) as data">
                      <div *ngIf="data.length > 0" class="articles-table-container">
                        <table mat-table [dataSource]="data" class="mat-elevation-z2">

                          <!-- Name Column -->
                          <ng-container matColumnDef="nombre">
                            <th mat-header-cell *matHeaderCellDef> Nombre </th>
                            <td mat-cell *matCellDef="let element"> {{element.nombre}} </td>
                          </ng-container>

                          <!-- Largo Column -->
                          <ng-container matColumnDef="largo">
                            <th mat-header-cell *matHeaderCellDef> Largo (cm) </th>
                            <td mat-cell *matCellDef="let element"> {{element.largo}} </td>
                          </ng-container>

                          <!-- Ancho Column -->
                          <ng-container matColumnDef="ancho">
                            <th mat-header-cell *matHeaderCellDef> Ancho (cm) </th>
                            <td mat-cell *matCellDef="let element"> {{element.ancho}} </td>
                          </ng-container>

                          <!-- Alto Column -->
                          <ng-container matColumnDef="alto">
                            <th mat-header-cell *matHeaderCellDef> Alto (cm) </th>
                            <td mat-cell *matCellDef="let element"> {{element.alto}} </td>
                          </ng-container>

                          <!-- Peso Column -->
                          <ng-container matColumnDef="peso">
                            <th mat-header-cell *matHeaderCellDef> Peso (kg) </th>
                            <td mat-cell *matCellDef="let element"> {{element.peso}} </td>
                          </ng-container>

                          <!-- Acciones Column -->
                          <ng-container matColumnDef="acciones">
                            <th mat-header-cell *matHeaderCellDef> Acciones </th>
                            <td mat-cell *matCellDef="let element; let i = index">
                              <button mat-icon-button color="warn" (click)="removeArticulo(i)">
                                <mat-icon>delete</mat-icon>
                              </button>
                            </td>
                          </ng-container>

                          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                        </table>
                      </div>

                      <div *ngIf="data.length === 0" class="no-articles-message">
                        <p>Aún no has añadido ningún artículo.</p>
                      </div>
                    </ng-container>
                  </div>

                  <div class="button-group">
                      <button mat-stroked-button matStepperPrevious>Anterior</button>
                      <button mat-flat-button matStepperNext *ngIf="secondFormGroup.valid">Continuar</button>
                  </div>
              </form>
          </mat-step>

          <mat-step [stepControl]="thirdFormGroup">
              <form [formGroup]="thirdFormGroup">
                  <ng-template matStepLabel>¿Cuándo?</ng-template>
                  <h2 class="section-title">¿Cuándo lo necesitás?</h2>
                  <mat-divider class="section-divider"></mat-divider>

                  <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Fecha de retiro</mat-label>
                  <input matInput [matDatepicker]="picker" formControlName="fecha">
                  <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                  <mat-datepicker #picker></mat-datepicker>
                  <mat-error *ngIf="thirdFormGroup.get('fecha')?.hasError('required')">
                      La fecha es requerida.
                  </mat-error>
                  </mat-form-field>
              
                  <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Hora de retiro</mat-label>
                      <input matInput
                          formControlName="horario"
                          [matTimepicker]="timePicker"
                          placeholder="HH:mm">
                      <mat-timepicker-toggle matSuffix [for]="timePicker"></mat-timepicker-toggle>
                      <mat-timepicker #timePicker></mat-timepicker>
                      <mat-error *ngIf="thirdFormGroup.get('horario')?.hasError('required')">
                          El horario es requerido.
                      </mat-error>
                      <mat-error *ngIf="thirdFormGroup.get('horario')?.hasError('invalidTimeFormat')">
                          El formato del horario no es válido.
                      </mat-error>
                  </mat-form-field>
              
                  <div class="button-group">
                      <button mat-stroked-button matStepperPrevious>Anterior</button>
                      <button mat-flat-button matStepperNext *ngIf="thirdFormGroup.valid && thirdFormGroup.get('horario')?.value">Calcular</button>
                  </div>
              </form>
          </mat-step>

          <mat-step label="Cotización" [stepControl]="thirdFormGroup">
              <form [formGroup]="thirdFormGroup">
                  <ng-template matStepLabel>Resumen</ng-template>
                      <h2 class="section-title">Tu presupuesto</h2>
                      <mat-divider class="section-divider"></mat-divider>

                      <mat-list *ngIf="!isCalculating && fleteData" class="flete-display">
                          <mat-list-item>Distancia: <strong>{{ fleteData.distancia | number: '1.2-2' }} Km</strong></mat-list-item>
                          <mat-divider class="calc-divider"></mat-divider>
                          <mat-list-item>Tarifa base + Km recorridos: <strong>{{ (fleteData.basePrice + fleteData.distancePrice) | currency: 'ARS':'symbol':'1.0-0' }}</strong></mat-list-item>
                          <mat-divider class="calc-divider"></mat-divider>
                          <mat-list-item>Cargos por Artículos/Mudanza: <strong>{{ fleteData.articleCosts | currency: 'ARS':'symbol':'1.0-0' }}</strong></mat-list-item>
                          <mat-divider class="calc-divider-subtotal"></mat-divider>
                          <mat-list-item class="subtotal-item"><span>Subtotal: </span><span><strong>{{ fleteData.subtotal | currency: 'ARS':'symbol':'1.0-0' }}</strong></span></mat-list-item>
                          <mat-divider class="calc-divider"></mat-divider>
                          <mat-list-item>IVA (21%): <strong>{{ fleteData.iva | currency: 'ARS':'symbol':'1.0-0' }}</strong></mat-list-item>
                          <mat-divider class="calc-divider-total"></mat-divider>
                          <mat-list-item class="total-item"><span>Total:</span><span><strong>{{ fleteData.total | currency: 'ARS':'symbol':'1.0-0' }}</strong></span></mat-list-item>
                      </mat-list>

                      <div *ngIf="!isCalculating && !fleteData" class="no-data-message">
                          <p>Presiona el botón "Siguiente" para iniciar el cálculo de la cotización.</p>
                      </div>
              </form>
              <div class="actions">
                  <button mat-button matStepperPrevious>Atrás</button>
                  <button matButton="outlined" (click)="resetForm()">
                      <mat-icon fontIcon="refresh"></mat-icon>Recalcular
                  </button>
              </div>
          </mat-step>
      </mat-stepper>

    </div>
  </mat-card>
  </div>
</main>